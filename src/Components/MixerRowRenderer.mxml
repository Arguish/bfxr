<?xml version="1.0" encoding="utf-8"?>
<s:ItemRenderer xmlns:fx="http://ns.adobe.com/mxml/2009" 
				xmlns:mx="library://ns.adobe.com/flex/mx" 
				xmlns:s="library://ns.adobe.com/flex/spark"
				
				 contentBackgroundColor="#CCBDA1" height="74" width="340"
				  creationComplete="CreationComplete(event)"
				  symbolColor="#CCBDA1">
	<s:layout>
		<s:BasicLayout/>
	</s:layout>
	
	<fx:Script>
		<![CDATA[
			import Mixer.MixerTrackView;
			
			import com.increpare.bfxr.synthesis.Synthesizer.SfxrSynth;
			
			import dataClasses.SoundData;
			
			import mx.binding.utils.BindingUtils;
			import mx.binding.utils.ChangeWatcher;
			import mx.events.FlexEvent;
			import mx.events.PropertyChangeEvent;
			import mx.events.PropertyChangeEventKind;
			import mx.events.SandboxMouseEvent;
			
			import spark.components.List;
			import spark.components.supportClasses.ListBase;
			import spark.skins.spark.CheckBoxSkin;
			
			public static const GraphWidth:int=191; 
			public static const GraphHeight:int=75; 
			
			private function PlayClick():void
			{
				var d:MixerTrackView=MixerTrackView(data);
				d.OnMixerPlayClick();
			}				
			
			private function CreationComplete(event:Event):void
			{				
				var app:sfxr_interface = this.parentApplication as sfxr_interface;		
				dropdown.dataProvider=app.soundItems;
				dropdown.selectedIndex=-1;
			}	
			
			private function DropdownChange(event:Event = null):void
			{				
				var d:MixerTrackView=MixerTrackView(data);
				d.trackindex = dropdown.selectedIndex;				
				d.OnMixerDropdownClick();			
			}
			
			private function DeselectClick():void
			{
				var d:MixerTrackView=MixerTrackView(data);
				dropdown.selectedIndex=-1;
				d.trackindex = -1;				
				d.OnMixerDropdownClick();		
			}						
			
			private function volumechangedStart(event:Event):void
			{				
				var mtv:MixerTrackView = data as MixerTrackView;
				mtv.OnMixerStartDrag();
			}						
			
			
			private function volumechanged(event:Event):void
			{
				var d:MixerTrackView=MixerTrackView(data);
				d.volume = volumeslider.value;
				d.OnMixerVolumeClick();
			}						
			
			private var sliderClickPosition:Point;
			
			private function sliderImageClick(event:MouseEvent):void
			{
				var mtv:MixerTrackView = data as MixerTrackView;
				mtv.OnMixerStartDrag();
				sliderClickPosition = sliderimage.globalToLocal(new Point(event.stageX,event.stageY));
				
				
				systemManager.getSandboxRoot().addEventListener(MouseEvent.MOUSE_MOVE, 
					system_SliderMouseMoveHandler, true);
				systemManager.getSandboxRoot().addEventListener(MouseEvent.MOUSE_UP, 
					system_SliderMouseUpHandler, true);
				systemManager.getSandboxRoot().addEventListener(SandboxMouseEvent.MOUSE_UP_SOMEWHERE, 
					system_SliderMouseUpHandler);	
				
				event.stopImmediatePropagation();
			}
			
			private function sliderImageContainerClick(event:MouseEvent):void
			{
				var mtv:MixerTrackView = data as MixerTrackView;
				mtv.OnMixerStartDrag();
				
				sliderClickPosition = new Point(sliderimage.width/2);
				
				systemManager.getSandboxRoot().addEventListener(MouseEvent.MOUSE_MOVE, 
					system_SliderMouseMoveHandler, true);
				systemManager.getSandboxRoot().addEventListener(MouseEvent.MOUSE_UP, 
					system_SliderMouseUpHandler, true);
				systemManager.getSandboxRoot().addEventListener(SandboxMouseEvent.MOUSE_UP_SOMEWHERE, 
					system_SliderMouseUpHandler);
				
				system_SliderMouseMoveHandler(event);
			}
			
			private function system_SliderMouseMoveHandler(event:MouseEvent):void
			{
				var pos:Point = new Point(event.stageX,event.stageY);
				
				var targetPoint:Point = new Point(pos.x-sliderClickPosition.x,pos.y-sliderClickPosition.y);
				
				var containerPosGlobal:Point = sliderimagecontainer.parent.localToGlobal(new Point(sliderimagecontainer.x,sliderimagecontainer.y));
				
				//clamp targetPoint
				if (targetPoint.x < containerPosGlobal.x)
				{
					targetPoint.x = containerPosGlobal.x;
				}
				if (targetPoint.x+sliderimage.width >= containerPosGlobal.x+sliderimagecontainer.width-1)
				{
					targetPoint.x = containerPosGlobal.x+sliderimagecontainer.width-sliderimage.width-2;
				}
			
				targetPoint = sliderimagecontainer.globalToLocal(targetPoint);
			
				sliderimage.x=int(targetPoint.x);
			}
			
			private function system_SliderMouseUpHandler(event:MouseEvent):void
			{
				systemManager.getSandboxRoot().removeEventListener(MouseEvent.MOUSE_MOVE, 
					system_SliderMouseMoveHandler, true);
				systemManager.getSandboxRoot().removeEventListener(MouseEvent.MOUSE_UP, 
					system_SliderMouseUpHandler, true);
				systemManager.getSandboxRoot().removeEventListener(SandboxMouseEvent.MOUSE_UP_SOMEWHERE, 
					system_SliderMouseUpHandler);
				
				SliderImageChangeEnd();		
			}
			
			private function PlayCallback(playingtime:Number):void
			{
				playline.x=Math.min(sliderimage.x+playingtime,sliderimagecontainer.width-3);
			}
			
			public function PlayCallbackAbsolute(playingtime:Number):void
			{
				playline.x=Math.min(playingtime,sliderimagecontainer.width-3);
			}
			
			public function PlayStart():void
			{
				playline.visible=true;
			}
			
			public function PlayStop(event:Event = null):void
			{
				playline.x=0;
				playline.visible=false;
			}
			
			private function SliderImageChangeEnd():void
			{				
				var app:sfxr_interface = this.parentApplication as sfxr_interface;	
				
				var d:MixerTrackView=MixerTrackView(data);
				d.onset = onsetSliderPosition;
				d.OnMixerOnsetClick();	
			}
						
			public function get onsetSliderPosition():Number
			{
				var left:Number = 0;
				var right:Number = (this.sliderimagecontainer.width-this.sliderimage.width);
				
				return this.sliderimage.x;
			}
			
			public function set onsetSliderPosition(n:Number):void
			{	
				sliderimage.x = n;
			}
			
		]]>
	</fx:Script>
	
	<s:Rect top="0" verticalCenter="0" bottom="0" left="0" horizontalCenter="0" right="0">
		<s:fill><s:SolidColor color="0xffccbda1" /></s:fill>	
	</s:Rect>
	
	<s:BorderContainer useHandCursor="true"  buttonMode="true" width="191" backgroundColor="0xccbda1" backgroundAlpha="1.0" right="0" mouseDown="sliderImageContainerClick(event)"  id="sliderimagecontainer" visible="{data.graphic!=null}" top="0" height="75">		
		<s:layout>
			<s:BasicLayout/>
		</s:layout>
		<mx:Image x="{data.onset}" y="0" useHandCursor="true"  buttonMode="true" mouseDown="sliderImageClick(event)" source="{data.graphic}" visible="{data.graphic!=null}" scaleContent="false" height="100%" id="sliderimage"/>
						
		<s:Rect top="-1" bottom="-2" left="-1" right="-1">
			<s:stroke>
				<mx:SolidColorStroke color="0"/>
			</s:stroke>		
		</s:Rect>	
		
		<s:Line id="playline" top="0" xFrom="0" yFrom="0" xTo="0"  yTo="71"  x="{Math.min(data.playbarposition,sliderimagecontainer.width-2)}" visible="{data.playbarposition>=0}">
			<s:stroke>
				<mx:SolidColorStroke color="0" alpha="1.0"/>			
			</s:stroke>
		</s:Line>
	</s:BorderContainer>
	
	
	<s:Rect top="0" bottom="-1" left="0" right="0">
		<s:stroke>
			<mx:SolidColorStroke color="0"/>
		</s:stroke>		
	</s:Rect>	
	<s:VSlider x="130" y="10" height="54" id="volumeslider" value="{data.volume}" minimum="0" maximum="2" changeStart="volumechangedStart(event)" changeEnd="volumechanged(event)" stepSize=".01" enabled="{data.trackindex>=0}"/>
	<s:DropDownList id="dropdown" x="14" y="10" selectedIndex="{data.trackindex}" change="DropdownChange(event)" requireSelection="false"></s:DropDownList>
	<s:Button x="14" y="43" enabled="{data.trackindex>=0}" id="PlayButton" label="Play" click="PlayClick()" />
	<s:Button x="92" y="43" enabled="{data.trackindex>=0}" id="Deselect" label="X" toolTip="Clears the channel." click="DeselectClick()" width="30" />

</s:ItemRenderer>